services:
  # HTTP Bridge - Convierte MCP a REST API
  http-bridge:
    build:
      context: ../mcp_orchestrator
      dockerfile: Dockerfile
    container_name: mcp-http-bridge
    ports:
      - "3001:3001"
    environment:
      - POSTGRES_HOST=mcp_orchestrator-postgres-1
      - POSTGRES_PORT=5432
      - POSTGRES_DB=mcp_logs
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - HTTP_BRIDGE_PORT=3001
    networks:
      - otel-network
      - mcp_orchestrator_default
    restart: unless-stopped
    command: node dist/http-bridge.js

  # Slack Bot
  slack-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: slack-chatops-bot
    env_file:
      - .env
    networks:
      - otel-network
      - mcp_orchestrator_default
    depends_on:
      - http-bridge
    restart: unless-stopped

  # Incident Notifier - Notificaciones proactivas en Slack
  incident-notifier:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: incident-notifier
    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_INCIDENTS_CHANNEL=${SLACK_INCIDENTS_CHANNEL:-incidents}
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
    networks:
      - otel-network
    depends_on:
      - http-bridge
    restart: unless-stopped
    command: node dist/incident-notifier.js

networks:
  otel-network:
    external: true
  mcp_orchestrator_default:
    external: true